<!DOCTYPE html>
<html>
<head>
	<title>Mapnik Bench</title>
	<link href='https://www.mapbox.com/base/latest/base.css' rel='stylesheet' />
	<script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
	<style>

	body {
		font-family: sans-serif;
		color: #f8f8f8;
	}
	table {
		border-collapse: collapse;
		background: #eee;
		color: #222b30;
	}
	table td,
	table th {
		border: 1px solid #222b30;
		padding: 10px;
		min-width: 100px;
	}
	th {
		background: #222b30;
		color: #eee;
	}
	.container {
		width: 80%;
		margin: 2em auto;
	}
	.geom,
	.ver,
	.env {
		font-family: monospace;
	}
	.ver {}
	.high {
		background: #2ECC40;
	}
	.low {
		background: #FF4136;
	}
	</style>
</head>
<body class="fill-navy">
	
	<div class="container col12 clearfix">
		<h1 id="time">TIME</h1>
		<div class="col12">
			<div class="col2 pad1y"><strong>Platform</strong><br><span class="env" id="platform"></span></div>
			<div class="col2 pad1y"><strong>Release</strong><br><span class="env" id="release"></span></div>
			<div class="col2 pad1y"><strong>Architecture</strong><br><span class="env" id="arch"></span></div>
		</div>
		<div id="data"></div>
	</div>	

<script>
var geometries = [];
var versions = [];
var bench;
// yay DOM strings :(

$(document).ready(function(){

	// var source = 'https://s3.amazonaws.com/mapbox/playground/mapsam/';
	var source = 'http://localhost:8000/visual/';
	var file = window.location.search.replace('?', '');
	file = '1454716008';
	console.log(file);

	$.getJSON( source+file+'.json', function( data ) {
		console.log(data);
		bench = data;

		// set time test was run
		var date = niceTime(new Date(bench.date*1000));
		$('#time').text(date);

		// set environment info
		$('#platform').text(bench.platform);
		$('#release').text(bench.release);
		$('#arch').text(bench.architecture);

		// for each version
		for (var v in data.versions) {
			var VERSION = data.versions[v];

			// gather versions if we haven't pushed yet
			if (versions.indexOf(v) == -1) versions.push(v);

			// for each test in the version
			for (var g in VERSION) {
				var GEOM = VERSION[g];

				// gather geometries if they haven't been added yet
				if (geometries.indexOf(g) == -1) geometries.push(g); 


			}
		}

		makeTheTable(geometries, versions);
	});
});

function makeTheTable(g, v) {

	// create headers
	var header = '<tr><th>Input file</th>';
	var table = '<table>';
	$.each(versions, function(v) {
		header+='<th class="ver">'+versions[v]+'</th>';
	});
	header += '</tr>';
	var rows = '';

	// go through each geometry and get the version information for that geom
	$.each(geometries, function(g) {
		var row = '<tr><td class="geom">'+geometries[g]+'</td>';
		$.each(versions, function(v) {
			// ummm yuck
			if (bench.versions &&
				bench.versions[versions[v]] &&
				bench.versions[versions[v]][geometries[g]] &&
				bench.versions[versions[v]][geometries[g]].result) {

				var B = bench.versions[versions[v]][geometries[g]].result;
				var time = Math.round(B.time * 1000) / 1000;
				var tps = Math.round(B.tiles_per_second * 1000) / 1000;
				var tpst = Math.round(B.tiles_per_second_per_thread * 1000) / 1000;

				row += '<td><strong>'+time+'</strong> seconds<br><small><strong>'+B.tiles_rendered+'</strong> total tiles rendered<br><strong>'+tps+'</strong> TPS<br><strong>'+tpst+'</strong> TPS per thread</small></td>';
				row += '<td><strong>'+B.total_mem_rss+'</strong> Total memory used<br><small><strong>'+B.mem_rss+'</strong> Peak Memory RSS<br><strong>'+B.mem_heap+'</strong> Peak Memory heap</small></td>';
			}
		});
		row += '</tr>';
		rows += row;
	});

	table += header + rows + '</table>';
	document.getElementById('data').innerHTML = table;
}

function niceTime(d) {
	var minutes = "0" + d.getMinutes();
	var seconds = "0" + d.getSeconds();
	var formattedTime = getMonth(d) + ' ' + d.getDate() + ', ' + d.getFullYear() + ' (' + d.getHours() + ':' + minutes.substr(-2) + ':' + seconds.substr(-2) + ')';
	return formattedTime;
}

function getMonth(d) {
	var month = d.getMonth();
	var months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
	return months[month];
}
</script>
</body>
</html>